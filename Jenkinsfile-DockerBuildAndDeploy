server = Artifactory.server "artifactory"
rtFullUrl = server.url
rtIpAddress = rtFullUrl - ~/^http?.:\/\// - ~/\/artifactory$/

buildInfo = Artifactory.newBuildInfo()

podTemplate(label: 'jenkins-pipeline' , cloud: 'k8s' , containers: [
        containerTemplate(name: 'docker', image: 'docker', command: 'cat', ttyEnabled: true , privileged: true)],
        volumes: [hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')]) {

    node('jenkins-pipeline') {

        stage('Cleanup') {
            cleanWs()
        }

        stage('Clone sources') {
            git url: 'https://github.com/yairbass/petclinic-docker.git', credentialsId: 'github' , branch: 'pipeline'
        }

       stage('Download PetClinic jar Artifact') {

               steps {
                   rtDownload (
                           buildName: 'Petclinic-BuildAndUpload',
                           serverId: artifactory,
                           specPath: './aql.json'
                   )
               }
           }





'''
Step 1 : Clone Repo 
Step 2 : Download Artifact from previous build
Step 3 : Build DockerImage using Privous build and Dockerfile
step 4 : Upload image
Step 5 : Run Xray on Container
Steo 6 : Create RB with helmChart of ]
Step 7 : Distribute RB to Edge node
Step 8: Deploy helm Chart with peclinic, mysql and traefik 
'''
