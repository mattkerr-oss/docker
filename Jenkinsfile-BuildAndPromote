pipeline {

  agent{
    kubernetes {
      cloud 'k8s'
      label 'jenkins-maven-pipeline'
      defaultContainer 'jnlp' 
        yaml """
            apiVersion: v1
            kind: Pod
            metadata:
              labels:
                name: jenkins-maven-pipeline
            spec:
              containers:
              - name: maven
                image: maven:3.6.0-jdk-11
                command:
                - cat
                tty: true
              - name: jfrog-cli
                image: docker.bintray.io/jfrog/jfrog-cli-go:latest
                command: 
                - cat
                tty: true
    """
    }
  }
//    environment{
//        server = Artifactory.server "artifactory"
//        rtFullUrl = server.url
//    }
    stages {
        stage ('Clone') {
            steps {
                git branch: 'pipeline', url: "https://github.com/yairbass/petclinic-docker.git", credentialsId: 'github'
            }
        }
        
        
      
        stage ('Artifactory configuration') {
            steps {
                rtMavenDeployer (
                    id: "MAVEN_DEPLOYER",
                    serverId: "artifactory",
                    releaseRepo: "maven-virtual",
                    snapshotRepo: "maven-virtual"
                    
                )

                rtMavenResolver (
                    id: "MAVEN_RESOLVER",
                    serverId: "artifactory",
                    releaseRepo: "maven-virtual",
                    snapshotRepo: "maven-virtual"
                   
                )
            }
        }

        stage ('Exec Maven') {
            environment{
                MAVEN_HOME = '/usr/share/maven'
            }
            steps {

                rtMavenRun (
                    tool: 'MAVEN_TOOL', // Tool name from Jenkins configuration
                    pom: 'pom.xml',
                    goals: 'package -Dmaven.test.skip=true ',
                    deployerId: "MAVEN_DEPLOYER",
                    resolverId: "MAVEN_RESOLVER"
                )
                sh 'tar -zcvf src.tgz src'
                sh 'tar -zcvf dbdata.tgz dbdata'
                container('jfrog-cli'){
                    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'artifactorypass', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
                        sh "jfrog rt c beta --user ${USERNAME} --password ${PASSWORD} --url ${rtFullUrl} < /dev/null"
                        sh "jfrog rt u '*.tgz' data-generic-repo --build-name=${env.JOB_NAME} --build-number=${env.BUILD_NUMBER} -server-id beta --props='release-bundle=true'"
                    }
                }
            }
        }
        stage ('SonarQube') {
            environment {
                scannerHome = tool 'sonar-server-7.6'
            }
            steps {
                withSonarQubeEnv('my-sonar-qube') {
                    sh "${scannerHome}/bin/sonar-scanner"
                        }
                }
            }
        
        stage("Quality Gate") {
            steps {
                // Fix for SonarQube issue for Pending Quality gates
                sh "sleep 10"
                timeout(time: 1, unit: 'HOURS') {
                    waitForQualityGate abortPipeline: true
                }
            }
    }
        stage ('Publish build info') {
            steps {
                rtPublishBuildInfo (
                    serverId: "artifactory"
                )
            }
        }
        
            stage ('Scan Build with xray') {
                steps {
                    script {
                        server = Artifactory.server "artifactory"
                        def scanConfig = [
                            'buildName'      : env.JOB_NAME,
                            'buildNumber'    : env.BUILD_NUMBER,
                            'failBuild'      : false
                          ]
                        def scanResult = server.xrayScan scanConfig
                        echo scanResult as String
                    }
                }
              }
            stage ('Promote to release'){
                steps {
                    rtPromote (
                    buildName: env.JOB_NAME,
                    buildNumber: env.BUILD_NUMBER,
                    serverId: 'artifactory',
                    targetRepo: 'maven-release-local',
                    comment: 'this is build had passed all tests is been promoted',
                    status: 'Released',
                    sourceRepo: 'maven-dev-local',
                    includeDependencies: false,
                    failFast: true,
                    copy: true
                )
       }
     }
    }
}
